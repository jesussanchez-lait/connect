rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para usuarios
    match /users/{userId} {
      // Usuarios autenticados (incluyendo anónimos) pueden crear, leer y actualizar su propio documento
      // IMPORTANTE: allow write incluye create, update y delete
      // Separamos create y update para mayor claridad
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Lectura pública por documentNumber (solo campos no sensibles)
      // Esto permite que la página [documentNumber] funcione sin autenticación
      allow read: if request.auth == null && 
        resource.data.documentNumber != null &&
        resource.data.role == 'FOLLOWER';
    }
    
    // Reglas para campañas
    match /campaigns/{campaignId} {
      // Lectura de campañas para usuarios autenticados
      allow read: if request.auth != null;
      
      // NOTA: Las actualizaciones de contadores de participants se manejan en el backend
      // o se ignoran si fallan (no bloquean el registro del usuario)
    }
    
    // Reglas para otros documentos (bloquear por defecto)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}